# ページング設計
**MR.AspNetCore.Paginationを使用した標準実装**

## 1. 概要

本ドキュメントは、ASP.NET Coreアプリケーションにおいて、  
`MR.AspNetCore.Pagination` ライブラリを利用したページング機能の設計・実装方針をまとめたものです。

本ライブラリは、
- **オフセットページング（Skip/Take）**
- **キーセットページング（カーソルページング/Seek方式）**
の両方を統一的にサポートします。

## 2. 使用ライブラリ

| ライブラリ名                                                                    | 説明                                                       |
| :------------------------------------------------------------------------------ | :--------------------------------------------------------- |
| [MR.AspNetCore.Pagination](https://github.com/mrahhal/MR.AspNetCore.Pagination) | ASP.NET Core向けのページング機能統合ライブラリ             |
| （内部）MR.EntityFrameworkCore.KeysetPagination                                 | キーセット（カーソル）ページング専用ライブラリ（間接使用） |

## 3. 主要機能

| 機能                       | 説明                                                        |
| :------------------------- | :---------------------------------------------------------- |
| オフセットページング       | Skip/Takeによる通常のページング                             |
| キーセットページング       | 最後取得したデータ以降を取得する高速ページング              |
| クエリパラメータ自動解析   | リクエストから `page`, `size`, `after`, `before` を自動取得 |
| 自動レスポンス構成         | ページ情報付きの標準レスポンス形式で返却                    |
| クエリプロジェクション対応 | DTO変換（AutoMapper/手動）を簡単に組み込める                |

## 4. 設定方法

### 4.1 サービス登録

`Program.cs` または `Startup.cs` に以下を追加します。

```csharp
builder.Services.AddPagination(options =>
{
    options.DefaultPageSize = 10;   // デフォルトページサイズ
    options.MaximumPageSize = 100;  // 最大ページサイズ
    options.PageQueryParameterName = "p";   // ページ番号クエリ名
    options.PageSizeQueryParameterName = "size"; // サイズクエリ名
});
```

## 5. 実装例
### 5.1 オフセットページング（通常ページング）

```csharp
[HttpGet]
public async Task<IActionResult> GetUsers()
{
    var result = await _paginationService.OffsetPaginateAsync(
        _context.Users.OrderByDescending(x => x.CreatedAt),
        query => query.Select(x => new UserDto
        {
            Id = x.Id,
            Name = x.Name,
            Email = x.Email
        })
    );

    return Ok(result);
}
```

- リクエスト例：
`/api/users?p=2&size=20`

- クエリパラメータからページ番号、ページサイズを自動取得

- 自動的に .Skip().Take() が適用される
### 5.2 キーセットページング（高速カーソルページング）
```csharp
[HttpGet]
public async Task<IActionResult> GetUsersKeyset()
{
    var result = await _paginationService.KeysetPaginateAsync(
        _context.Users,
        b => b.Descending(x => x.CreatedAt).Descending(x => x.Id),
        async id => await _context.Users.FindAsync(int.Parse(id)),
        query => query.Select(x => new UserDto
        {
            Id = x.Id,
            Name = x.Name,
            Email = x.Email
        })
    );

    return Ok(result);
}
```

- リクエスト例：
- /api/users?after=12345&size=20

- 「あるデータ（例：ID=12345）の次から20件」を高速取得

- 大容量テーブルでも高速


## 6. レスポンス形式

| フィールド                                            | 説明                   |
| :---------------------------------------------------- | :--------------------- |
| items                                                 | 取得されたデータリスト |
| pageIndex / hasNext / hasPrevious（オフセットの場合） | ページ情報             |
| nextCursor / previousCursor（キーセットの場合）       | カーソル情報           |

### 例（オフセットページング結果）

```json
{
  "items": [
    {
      "id": 1,
      "name": "山田太郎",
      "email": "taro@example.com"
    }
  ],
  "pageIndex": 2,
  "pageSize": 20,
  "totalCount": 137,
  "hasNext": true,
  "hasPrevious": true
}
```

## 7. 注意事項

- 大規模データではパフォーマンス劣化の可能性あり（できればキーセット推奨） 
- キーセットページングの制限任意のページジャンプは不可。順番移動（次/前）だけ可能                    
- 必ずOrderByを指定すること    
- キーセットでは決定論的なキーを指定すること  例：`CreatedAt` + `Id` の複合キーを設定